<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>GoToSocial Access Token è·å–å·¥å…·</title>
    <style>
        /* ä»…ä½¿ç”¨å†…è”æ ·å¼ï¼Œä½†ä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œå°†é€šç”¨æ ·å¼æ”¾åœ¨è¿™é‡Œ */
        body { font-family: sans-serif; line-height: 1.6; }
        h1, h2 { margin-top: 0; }
        section { padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .input-text { width: 80%; padding: 8px; margin-bottom: 10px; }
        .button-style { padding: 10px 20px; color: white; border: none; cursor: pointer; border-radius: 4px; }
        .btn-primary { background-color: #007bff; }
        .btn-success { background-color: #28a745; }
        .btn-danger { background-color: #dc3545; }
        .highlighted { border: 2px solid #4CAF50 !important; background-color: #e8f5e9 !important; }
        .normal { border: 1px solid #ccc !important; background-color: white !important; }
    </style>
</head>
<body>

    <h1 style="color: #0056b3;">ğŸ”‘ GoToSocial Access Token è·å–å·¥å…·</h1>
    <hr>

    <div id="main_container">
        
        <section id="step1_register" class="highlighted">
            <h2 style="color: #007bff;">æ­¥éª¤ 1: æ³¨å†Œåº”ç”¨å¹¶è·å– ID/Secret</h2>
            
            <p style="font-weight: bold;">1A. å‰å¾€æ³¨å†Œé¡µé¢ï¼š</p>
            
            <label for="instance_url">å®ä¾‹ URL:</label>
            <input type="url" id="instance_url" value="https://" class="input-text" required>
            
            <br/><a id="register_link" href="#" target="_blank" style="color: #dc3545; font-weight: bold; margin-left: 10px;" onclick="updateRegistrationLink(event)">[å¡«å†™å®Œæˆåç‚¹å‡»æ­¤å¤„æ‰“å¼€åº”ç”¨æ³¨å†Œé¡µé¢]</a>
            
            <p style="margin-top: 15px; font-weight: bold;">æ“ä½œæŒ‡å¯¼ï¼š</p>
            <ol>
                <li>è¯·ç‚¹å‡»ä¸Šæ–¹çš„é“¾æ¥ï¼Œåœ¨æ–°é¡µé¢ä¸­ç™»å½•æ‚¨çš„ GoToSocial è´¦æˆ·ã€‚</li>
                <li>åœ¨æ–°é¡µé¢çš„æ³¨å†Œè¡¨å•ä¸­ï¼š
                    <ul>
                        <li><b>Application name (åº”ç”¨åç§°):</b> <b>å¿…é¡»</b> å¡«å†™ä¸€ä¸ªåå­—ï¼ˆä¾‹å¦‚ï¼š`MyTokenTool`ï¼‰ã€‚</li>
                        <li><b>Redirect URIs (é‡å®šå‘ URI):</b>æ— éœ€å¡«å†™ï¼Œç•™ç©ºå³å¯</li>
                        <li><b>Scopes (æƒé™èŒƒå›´):</b>æ— éœ€å¡«å†™ï¼Œç•™ç©ºå³å¯</li>
                    </ul>
                </li>
                <li>ç‚¹å‡» <b>â€œåˆ›å»º (Create)â€</b>ï¼Œç„¶åå°†é¡µé¢æ˜¾ç¤ºçš„ <b>Client ID</b> å’Œ <b>Client Secret</b> å¤åˆ¶åˆ°ä¸‹æ–¹ã€‚</li>
            </ol>
            
            <p style="font-weight: bold;">1B. å¤åˆ¶è¿”å›çš„å‡­è¯åˆ°ä¸‹æ–¹ï¼š</p>

            <label for="client_id">Client ID:</label>
            <input type="text" id="client_id" class="input-text" required><br>

            <label for="client_secret">Client Secret:</label>
            <input type="text" id="client_secret" class="input-text" required><br>

            <button onclick="updateStepHighlight(2)" class="button-style btn-primary">å®Œæˆæ­¥éª¤ 1ï¼Œè¿›å…¥æ­¥éª¤ 2</button>
        </section>

        <hr>

        <section id="step2_authcode" class="normal">
            <h2 style="color: #28a745;">æ­¥éª¤ 2: è·å–æˆæƒç  (Code)</h2>
            
            <p style="font-weight: bold;">2A. æˆæƒï¼š</p>
            <p>è¯·å¤åˆ¶ä¸‹é¢çš„é“¾æ¥åˆ°æµè§ˆå™¨ä¸­æ‰“å¼€ï¼Œæ‰§è¡Œæˆæƒæ“ä½œï¼š</p>
            <textarea id="auth_url_output" style="width: 90%; height: 80px; padding: 5px; border: 1px dashed #008000; margin-bottom: 10px;" readonly></textarea>
            
            <p style="font-weight: bold;">æ“ä½œæŒ‡å¯¼ï¼š</p>
            <p>å®Œæˆæˆæƒåï¼Œæ–°é¡µé¢å°†æ˜¾ç¤ºä¸€è¡Œæ–‡å­—ï¼š<b><code>Here's your out-of-band token...</code></b>ï¼Œåé¢çš„é•¿å­—ç¬¦ä¸²å°±æ˜¯æ‚¨çš„ <b>æˆæƒç  (Code)</b>ã€‚</p>

            <p style="font-weight: bold;">2B. å¤åˆ¶æˆæƒç ï¼š</p>
            <label for="auth_code">ç²˜è´´æ‚¨å¤åˆ¶çš„æˆæƒç  (Code):</label><br>
            <input type="text" id="auth_code" class="input-text" required><br>

            <button onclick="updateStepHighlight(3)" class="button-style btn-success">å®Œæˆæ­¥éª¤ 2ï¼Œæœ€ç»ˆäº¤æ¢ Token</button>
        </section>
        
        <hr>

        <section id="step3_exchange" class="normal">
            <h2 style="color: #dc3545;">æ­¥éª¤ 3: äº¤æ¢ Access Token</h2>
            
            <p style="font-weight: bold;">3A. è¿è¡Œäº¤æ¢ï¼š</p>
            <p>ç‚¹å‡»æŒ‰é’®åï¼Œè„šæœ¬å°†ä½¿ç”¨æ‚¨æä¾›çš„ ID/Secret å’Œ Codeï¼Œåœ¨æµè§ˆå™¨ä¸­å®Œæˆæœ€ç»ˆçš„ Token äº¤æ¢ã€‚</p>
            
            <button onclick="getAccessToken()" class="button-style btn-danger">ç‚¹å‡»è¿è¡Œï¼šè·å– Access Token</button>

            <p style="margin-top: 15px; font-weight: bold;">3B. ç»“æœï¼š</p>
            <div id="result_output" style="border: 1px solid #ccc; padding: 15px; margin-top: 10px; background-color: #fff8e1; min-height: 50px; word-wrap: break-word;">
                Access Token å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
            </div>
        </section>

    </div>

    <script>
        let globalConfig = { redirectUri: "urn:ietf:wg:oauth:2.0:oob", scopes: "read" };

        // --- UI å’Œé«˜äº®æ§åˆ¶ ---
        function getStepElement(step) {
            if (step === 1) return document.getElementById('step1_register');
            if (step === 2) return document.getElementById('step2_authcode');
            if (step === 3) return document.getElementById('step3_exchange');
            return null;
        }

        function highlightStep(step) {
            [1, 2, 3].forEach(s => {
                const element = getStepElement(s);
                if (element) {
                    element.className = (s === step) ? 'highlighted' : 'normal';
                }
            });
        }

        // é¡µé¢åˆå§‹åŒ–æ—¶ï¼Œåªé«˜äº® Step 1
        window.onload = function() {
            highlightStep(1);
            document.getElementById('result_output').innerHTML = 'è¯·å…ˆå®Œæˆæ­¥éª¤ 1ã€‚';
        };

        // --- Step 1: å®ä¾‹ URL å¤„ç† ---
        function updateRegistrationLink(event) {
            const instanceUrl = document.getElementById('instance_url').value.trim().replace(/\/$/, '');
            if (!instanceUrl) {
                event.preventDefault();
                alert('è¯·å…ˆè¾“å…¥å®ä¾‹ URLï¼');
                return;
            }
            
            // GoToSocial/Mastodon çš„åº”ç”¨æ³¨å†Œé¡µé¢è·¯å¾„
            const registerPageUrl = `${instanceUrl}/settings/user/applications/new`;
            document.getElementById('register_link').href = registerPageUrl;

            // å­˜å‚¨å®ä¾‹ URL
            globalConfig.instanceUrl = instanceUrl;
            
            // é˜»æ­¢é»˜è®¤è·³è½¬ï¼Œæ‰‹åŠ¨åœ¨æ–°çª—å£æ‰“å¼€
            event.preventDefault();
            window.open(registerPageUrl, '_blank');
        }

        // --- æ­¥éª¤æ§åˆ¶å‡½æ•° ---
        function updateStepHighlight(nextStep) {
            // éªŒè¯å’Œæ•°æ®æ”¶é›†
            if (nextStep === 2) {
                const instanceUrl = document.getElementById('instance_url').value.trim().replace(/\/$/, '');
                const clientId = document.getElementById('client_id').value.trim();
                const clientSecret = document.getElementById('client_secret').value.trim();

                if (!instanceUrl || !clientId || !clientSecret) {
                    alert('é”™è¯¯ï¼šè¯·ç¡®ä¿æ‰€æœ‰å‡­è¯éƒ½å·²å¡«å†™ã€‚');
                    return;
                }
                
                // å­˜å‚¨å¹¶ç”Ÿæˆæˆæƒ URL
                globalConfig = { ...globalConfig, instanceUrl, clientId, clientSecret };
                const authUrl = `${instanceUrl}/oauth/authorize?response_type=code&client_id=${clientId}&redirect_uri=${globalConfig.redirectUri}&scope=${globalConfig.scopes}`;
                document.getElementById('auth_url_output').value = authUrl;

            } else if (nextStep === 3) {
                const authCode = document.getElementById('auth_code').value.trim();
                if (!authCode) {
                    alert('é”™è¯¯ï¼šè¯·å…ˆç²˜è´´æˆæƒç  (Code)ï¼');
                    return;
                }
                globalConfig.authCode = authCode;
            }

            // æ›´æ–°é«˜äº®å’Œæ»šåŠ¨
            highlightStep(nextStep);
            const nextElement = getStepElement(nextStep);
            if (nextElement) nextElement.scrollIntoView({ behavior: 'smooth' });
        }


        // --- æœ€ç»ˆæ­¥éª¤ï¼šè·å– Access Token ---
        function getAccessToken() {
            const output = document.getElementById('result_output');
            
            // æœ€ç»ˆæ£€æŸ¥
            if (!globalConfig.authCode || !globalConfig.clientId) {
                output.innerHTML = '<span style="color: red;">é”™è¯¯ï¼šè¯·è¿”å›æ­¥éª¤ 1 å’Œ 2 ç¡®ä¿æ‰€æœ‰ä¿¡æ¯å·²è¾“å…¥ã€‚</span>';
                highlightStep(1);
                return;
            }

            output.innerHTML = 'æ­£åœ¨å‘é€è¯·æ±‚ï¼Œåœ¨æµè§ˆå™¨ä¸­äº¤æ¢ Access Token...';
            highlightStep(3);
            
            // æ„é€  Token äº¤æ¢è¯·æ±‚çš„ Body
            const tokenUrl = `${globalConfig.instanceUrl}/oauth/token`;
            
            const params = new URLSearchParams();
            params.append('grant_type', 'authorization_code');
            params.append('client_id', globalConfig.clientId);
            params.append('client_secret', globalConfig.clientSecret);
            params.append('redirect_uri', globalConfig.redirectUri);
            params.append('code', globalConfig.authCode);
            
            // ä½¿ç”¨ fetch API å‘é€ POST è¯·æ±‚
            fetch(tokenUrl, {
                method: 'POST',
                // Content-Type: application/x-www-form-urlencoded
                body: params
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(`HTTP é”™è¯¯ ${response.status}: ${JSON.stringify(errorData, null, 2)}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // æˆåŠŸè·å– Access Token
                if (data.access_token) {
                    output.innerHTML = `
                        <p style="color: green; font-weight: bold; font-size: 1.2em;">ğŸ‰ Access Token è·å–æˆåŠŸï¼</p>
                        <p>è¯·å¤åˆ¶ä»¥ä¸‹ Access Tokenï¼š</p>
                        <textarea style="width: 90%; height: 100px; padding: 5px; border: 2px solid #008000;" readonly>${data.access_token}</textarea>
                        <p>Token ç±»å‹: ${data.token_type}</p>
                    `;
                } else {
                    output.innerHTML = '<span style="color: orange;">è·å–å¤±è´¥ï¼šå“åº”ä¸­ç¼ºå°‘ Access Tokenã€‚</span><br>' + JSON.stringify(data, null, 2);
                }
            })
            .catch(error => {
                console.error("Token äº¤æ¢å¤±è´¥:", error);
                output.innerHTML = `<span style="color: red; font-weight: bold;">å‘ç”Ÿé”™è¯¯ï¼šè¯·æ£€æŸ¥æ‚¨çš„å‡­è¯æˆ– Code æ˜¯å¦æ­£ç¡®ã€‚</span><pre style="white-space: pre-wrap; font-family: monospace;">${error.message}</pre>`;
            });
        }
    </script>

</body>
</html>